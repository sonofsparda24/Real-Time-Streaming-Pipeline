@version: 3.35

###############################################################################
# 1. GLOBAL OPTIONS
###############################################################################

options {
    time-reap(30);
    mark-freq(3600);
    keep-hostname(yes);
    chain-hostnames(no);
    flush-lines(0);
    threaded(yes);
};

###############################################################################
# 2. SOURCE DEFINITIONS
###############################################################################

# UDP syslog input (port 5514)
source s_udp {
    network(
        ip("0.0.0.0")
        port(5514)
        transport("udp")
    );
};

# TCP syslog input (port 6514)
source s_tcp {
    network(
        ip("0.0.0.0")
        port(6514)
        transport("tcp")
    );
};

###############################################################################
# 3. PARSER — PARSE SYSLOG AND CONVERT TO JSON
###############################################################################

parser p_syslog {
    syslog-parser();
};

template t_json {
    template("$(format-json date=$DATE
                            host=$HOST
                            program=$PROGRAM
                            pid=$PID
                            message=$MESSAGE
                            facility=$FACILITY
                            priority=$PRIORITY
                            level=${LEVEL_NUM}
                            .json-escape=yes)\n");
};

###############################################################################
# 4. DESTINATION — SEND TO KAFKA
###############################################################################

destination d_kafka {
    kafka(
        bootstrap-servers("kafka:9092")
        topic("syslog_raw")
        template("$(format-json --scope full --rekey .)")
        message("$(format-json date=$DATE
                               host=$HOST
                               program=$PROGRAM
                               pid=$PID
                               message=$MESSAGE
                               facility=$FACILITY
                               priority=$PRIORITY
                               level=${LEVEL_NUM})")
    );
};

###############################################################################
# 5. LOG PATH — CONNECT SOURCES → PARSER → KAFKA
###############################################################################

log {
    source(s_udp);
    source(s_tcp);
    parser(p_syslog);
    destination(d_kafka);
};
